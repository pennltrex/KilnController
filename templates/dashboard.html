<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiln Controller Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2em;
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            justify-content: center;
            border-bottom: 2px solid #ddd;
        }

        .tab-button {
            padding: 12px 30px;
            background: transparent;
            color: #666;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-button:hover {
            color: #333;
            background: #f9f9f9;
        }

        .tab-button.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .card h2 {
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
            font-weight: 600;
        }

        .temp-display {
            font-size: 3em;
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
            margin: 20px 0;
        }

        .temp-unit {
            font-size: 0.5em;
            color: #999;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.active {
            background: #27ae60;
        }

        .status-indicator.inactive {
            background: #95a5a6;
        }

        .status-indicator.emergency {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #666;
            font-weight: 500;
        }

        .info-value {
            color: #333;
            font-weight: bold;
        }

        .chart-card {
            grid-column: 1 / -1;
            height: 450px;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .schedule-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .schedule-item {
            padding: 12px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .schedule-item:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .schedule-item.selected {
            background: #e8f4fd;
            border-left: 3px solid #3498db;
        }
        
        .schedule-info {
            margin-bottom: 10px;
        }

        .schedule-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1em;
        }

        .schedule-details {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 4px;
        }

        .schedule-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
            min-width: auto;
        }
        
        .segment-editor {
            margin: 15px 0;
        }
        
        .segment-item {
            background: #fafafa;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            align-items: center;
        }

        .schedule-segment-item {
            background: #fafafa;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            margin-bottom: 8px;
        }

        .schedule-segment-item .segment-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .schedule-segment-item .segment-details {
            font-size: 0.9em;
            color: #666;
        }
        
        .schedule-segment-item .segment-time {
            font-size: 0.85em;
            color: #999;
            margin-top: 2px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 4px;
        }
        
        .input-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 0.95em;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn-remove {
            background: #e74c3c;
            color: white;
            padding: 8px 12px;
            border: 1px solid #e74c3c;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-remove:hover {
            background: #c0392b;
            border-color: #c0392b;
        }
        
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 0.95em;
            margin: 10px 0;
            width: 100%;
            background: white;
        }

        select:focus {
            outline: none;
            border-color: #3498db;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            outline: none;
            margin: 8px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        button {
            flex: 1;
            min-width: 120px;
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            background: white;
            color: #333;
        }

        button:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .btn-primary:hover {
            background: #2980b9;
            border-color: #2980b9;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
            border-color: #c0392b;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button:disabled:hover {
            background: #3498db;
            border-color: #3498db;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #3498db;
            transition: width 0.3s;
        }

        .cone-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            text-align: center;
        }

        .cone-value {
            font-size: 2em;
            font-weight: 700;
            margin: 5px 0;
        }

        .cone-label {
            font-size: 0.9em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .cone-info-text {
            font-size: 0.85em;
            margin-top: 5px;
            opacity: 0.85;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 3px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid;
        }

        .alert.error {
            background: #fadbd8;
            border-color: #e74c3c;
            color: #c0392b;
        }

        .alert.success {
            background: #d5f4e6;
            border-color: #27ae60;
            color: #1e8449;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            
            .temp-display {
                font-size: 2.5em;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kiln Controller</h1>
        
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab-button" onclick="switchTab('history')">Firing History</button>
            <button class="tab-button" onclick="switchTab('settings')">Settings</button>
        </div>
        
        <div id="alert" class="alert"></div>
        
        <div id="dashboard-tab" class="tab-content active">
            <div class="dashboard">
                <div class="card">
                    <h2>Current Status</h2>
                    <div class="temp-display">
                        <span id="current-temp">--</span><span class="temp-unit" id="temp-unit-main">¬∞C</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Setpoint:</span>
                        <span class="info-value"><span id="setpoint">--</span><span id="temp-unit-setpoint">¬∞C</span></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Output:</span>
                        <span class="info-value"><span id="output">--</span>%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="output-bar"></div>
                    </div>
                    <div class="info-row" style="margin-top: 15px;">
                        <span class="info-label">Firing Status:</span>
                        <span class="info-value">
                            <span class="status-indicator" id="status-indicator"></span>
                            <span id="firing-status">Idle</span>
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Current Segment:</span>
                        <span class="info-value"><span id="current-segment">--</span> / <span id="total-segments">--</span></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Elapsed Time:</span>
                        <span class="info-value" id="elapsed-time">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Time Remaining:</span>
                        <span class="info-value" id="time-remaining">--</span>
                    </div>

                    <!-- Pyrometric Cone Display -->
                    <div class="cone-display" id="cone-display" style="display: none;">
                        <div class="cone-label">Pyrometric Cone</div>
                        <div class="cone-value" id="cone-value">--</div>
                        <div class="cone-info-text" id="cone-info">Tracking heat-work</div>
                    </div>

                    <div class="info-row">
                        <span class="info-label">Last Update:</span>
                        <span class="info-value" id="last-update">--</span>
                    </div>
                    <div class="info-row" style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #f0f0f0;">
                        <span class="info-label" style="font-size: 0.85em;">PID:</span>
                        <span class="info-value" style="font-size: 0.85em;" id="pid-display">Kp:-- Ki:-- Kd:--</span>
                    </div>
                </div>

                <div class="card">
                    <h2>Active Schedule</h2>
                    <div id="active-schedule-name" style="font-weight: bold; color: #667eea; margin-bottom: 10px;">
                        No schedule loaded
                    </div>
                    <div id="active-schedule-summary" style="color: #666; font-size: 0.9em;">
                        Select a schedule from the controls section to begin
                    </div>
                </div>

                <div class="card" id="resume-card" style="display: none; border: 2px solid #f59e0b; background: #fef3c7;">
                    <h2 style="color: #f59e0b;">‚ö†Ô∏è Resume Interrupted Firing</h2>
                    <p style="color: #92400e; margin-bottom: 10px;">
                        A previous firing was interrupted. You can resume from where it left off.
                    </p>
                    <div id="resume-details" style="background: white; padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <div style="font-size: 0.9em; color: #666;">
                            <div><strong>Schedule:</strong> <span id="resume-schedule-name">--</span></div>
                            <div><strong>Segment:</strong> <span id="resume-segment">--</span></div>
                            <div><strong>Last saved:</strong> <span id="resume-timestamp">--</span></div>
                            <div><strong>Elapsed time:</strong> <span id="resume-elapsed">--</span></div>
                        </div>
                    </div>
                    <div class="controls">
                        <button class="btn-primary" onclick="resumeFiring()">
                            Resume Firing
                        </button>
                        <button class="btn-danger btn-small" onclick="clearResumeState()">
                            Discard and Start Fresh
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2>Controls</h2>
                    <div class="input-group">
                        <label>Select Firing Schedule:</label>
                        <select id="schedule-select">
                            <option value="">-- No schedule loaded --</option>
                        </select>
                    </div>
                    <div class="controls">
                        <button class="btn-primary" id="start-btn" onclick="startFiring()" disabled>
                            Start Firing
                        </button>
                        <button class="btn-danger" id="stop-btn" onclick="stopFiring()" disabled>
                            Emergency Stop
                        </button>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                        ‚ö†Ô∏è Select a schedule before starting
                    </p>
                </div>

                <div class="card">
                    <h2>üî• Cone Fire Mode</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        Automatically generate a firing schedule based on cone number and firing speed
                    </p>
                    <div class="input-group">
                        <label>Cone Number:</label>
                        <select id="cone-select">
                            <option value="">-- Select Cone --</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Firing Speed:</label>
                        <select id="speed-select">
                            <option value="slow">Slow (44¬∞C/hr final) - Delicate work</option>
                            <option value="medium" selected>Medium (67¬∞C/hr final) - Standard</option>
                            <option value="fast">Fast (111¬∞C/hr final) - Quick firing</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Preheat/Candling (hours):</label>
                        <input type="number" id="preheat-input" value="0" min="0" max="12" step="0.5" placeholder="0">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Optional low-temperature hold for water smoking and burnout
                        </small>
                    </div>
                    <div class="input-group">
                        <label>Hold at Peak (minutes):</label>
                        <input type="number" id="hold-input" value="0" min="0" max="120" step="5" placeholder="0">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Hold time at target temperature (typical: 10-30 minutes)
                        </small>
                    </div>
                    <div class="controls">
                        <button class="btn-primary" onclick="loadConeFireSchedule()">
                            Generate & Load Schedule
                        </button>
                    </div>
                    <div id="cone-fire-info" style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px; display: none;">
                        <!-- Cone fire info will be displayed here -->
                    </div>
                </div>

                <div class="card">
                    <h2>Firing Schedules</h2>
                    <div class="schedule-list" id="schedule-list">
                        <p style="color: #999; text-align: center; padding: 20px;">Loading schedules...</p>
                    </div>
                    <div class="controls">
                        <button class="btn-primary" onclick="showScheduleEditor()">
                            Create New Schedule
                        </button>
                    </div>
                </div>

                <div class="card" id="schedule-editor" style="display: none;">
                    <h2>Schedule Editor</h2>
                    <div class="input-group">
                        <label>Schedule Name:</label>
                        <input type="text" id="schedule-name" placeholder="e.g., Bisque Cone 04">
                    </div>
                    <div class="segment-editor" id="segment-editor">
                        <!-- Segments will be added here -->
                    </div>
                    <div class="controls">
                        <button class="btn-primary" onclick="addSegment()">
                            Add Segment
                        </button>
                        <button class="btn-primary" onclick="saveSchedule()">
                            Save Schedule
                        </button>
                        <button class="btn-danger btn-small" onclick="cancelEdit()">
                            Cancel
                        </button>
                    </div>
                </div>

                <div class="card chart-card">
                    <h2>Temperature History</h2>
                    <div class="chart-container">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="history-tab" class="tab-content">
            <div class="dashboard">
                <div class="card" style="grid-column: 1 / -1;">
                    <h2>Past Firings</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        View and review data from completed firings
                    </p>

                    <div id="firings-list" style="max-height: 600px; overflow-y: auto;">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            Loading firing history...
                        </div>
                    </div>
                </div>

                <div class="card" id="firing-detail-card" style="grid-column: 1 / -1; display: none;">
                    <h2>Firing Details: <span id="firing-detail-name">--</span></h2>
                    <button class="btn-secondary" onclick="closeFiringDetail()" style="margin-bottom: 15px;">
                        ‚Üê Back to List
                    </button>

                    <div id="firing-summary" style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                        <!-- Summary will be populated dynamically -->
                    </div>

                    <div class="chart-container" style="margin-bottom: 20px;">
                        <canvas id="firingHistoryChart"></canvas>
                    </div>

                    <div style="margin-top: 15px;">
                        <h3 style="font-size: 1.1em; margin-bottom: 10px;">Data Points</h3>
                        <div id="firing-data-table" style="max-height: 400px; overflow-y: auto;">
                            <!-- Data table will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="settings-tab" class="tab-content">
            <div class="dashboard">
                <div class="card">
                    <h2>PID Tuning</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        Adjust these values to fine-tune temperature control
                    </p>

                    <button class="btn-primary" onclick="autoTunePID()" style="width: 100%; margin-bottom: 20px;">
                        Auto-Tune PID
                    </button>
                    <p style="color: #666; font-size: 0.85em; margin-bottom: 15px; text-align: center;">
                        Or adjust manually:
                    </p>

                    <div class="input-group" style="margin-bottom: 10px;">
                        <label>Kp (Proportional): <span id="kp-value">1.0</span></label>
                        <input type="range" id="kp-slider" min="0.1" max="5.0" step="0.1" value="1.0" style="width: 100%;">
                    </div>
                    <div class="input-group" style="margin-bottom: 10px;">
                        <label>Ki (Integral): <span id="ki-value">0.1</span></label>
                        <input type="range" id="ki-slider" min="0" max="2.0" step="0.05" value="0.1" style="width: 100%;">
                    </div>
                    <div class="input-group" style="margin-bottom: 15px;">
                        <label>Kd (Derivative): <span id="kd-value">0.5</span></label>
                        <input type="range" id="kd-slider" min="0" max="3.0" step="0.1" value="0.5" style="width: 100%;">
                    </div>
                    <button class="btn-primary" onclick="updatePID()" style="width: 100%;">
                        Apply PID Settings
                    </button>
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.85em;">
                        <strong>Quick Guide:</strong><br>
                        ‚Ä¢ <strong>Overshoot?</strong> Decrease Kp, increase Kd<br>
                        ‚Ä¢ <strong>Too slow?</strong> Increase Kp<br>
                        ‚Ä¢ <strong>Steady error?</strong> Increase Ki<br>
                        ‚Ä¢ <strong>Oscillating?</strong> Decrease Kp and Ki
                    </div>
                </div>

                <div class="card">
                    <h2>PID Advanced Settings</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        Advanced PID configuration parameters
                    </p>

                    <div class="input-group" style="margin-bottom: 10px;">
                        <label>Sample Time (seconds): <span id="pid-sample-time-value">1.0</span></label>
                        <input type="range" id="pid-sample-time-slider" min="0.5" max="5.0" step="0.5" value="1.0" style="width: 100%;">
                    </div>
                    <div class="input-group" style="margin-bottom: 10px;">
                        <label>Output Min (%): <span id="output-min-value">0</span></label>
                        <input type="range" id="output-min-slider" min="0" max="50" step="5" value="0" style="width: 100%;">
                    </div>
                    <div class="input-group" style="margin-bottom: 15px;">
                        <label>Output Max (%): <span id="output-max-value">100</span></label>
                        <input type="range" id="output-max-slider" min="50" max="100" step="5" value="100" style="width: 100%;">
                    </div>
                    <button class="btn-primary" onclick="updatePIDAdvanced()" style="width: 100%;">
                        Apply Advanced Settings
                    </button>
                </div>

                <div class="card">
                    <h2>Safety Settings</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        Configure temperature safety limits
                    </p>

                    <div class="input-group" style="margin-bottom: 10px;">
                        <label>Maximum Temperature (¬∞C): <span id="max-temp-value">1300</span></label>
                        <input type="range" id="max-temp-slider" min="500" max="1500" step="50" value="1300" style="width: 100%;">
                    </div>
                    <div class="input-group" style="margin-bottom: 15px;">
                        <label>Safety Margin (¬∞C): <span id="safety-margin-value">50</span></label>
                        <input type="range" id="safety-margin-slider" min="10" max="100" step="10" value="50" style="width: 100%;">
                    </div>
                    <button class="btn-primary" onclick="updateSafetySettings()" style="width: 100%;">
                        Apply Safety Settings
                    </button>
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px; font-size: 0.85em;">
                        <strong>‚ö†Ô∏è Warning:</strong> Safety settings protect your kiln from overheating. Only change these if you understand the implications.
                    </div>
                </div>

                <div class="card">
                    <h2>Control Settings</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        Configure relay and temperature update intervals
                    </p>

                    <div class="input-group" style="margin-bottom: 10px;">
                        <label>Relay Cycle Time (seconds): <span id="relay-cycle-value">10.0</span></label>
                        <input type="range" id="relay-cycle-slider" min="5" max="30" step="1" value="10" style="width: 100%;">
                    </div>
                    <div class="input-group" style="margin-bottom: 15px;">
                        <label>Temperature Update Interval (seconds): <span id="temp-update-value">2.0</span></label>
                        <input type="range" id="temp-update-slider" min="1" max="10" step="1" value="2" style="width: 100%;">
                    </div>
                    <button class="btn-primary" onclick="updateControlSettings()" style="width: 100%;">
                        Apply Control Settings
                    </button>
                </div>

                <div class="card">
                    <h2>Kiln Sitter Settings</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        Configure automatic shutdown detection for kiln sitter operation
                    </p>

                    <div class="input-group" style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="kiln-sitter-mode" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                            <span>Enable Kiln Sitter Mode</span>
                        </label>
                        <p style="color: #999; font-size: 0.8em; margin-top: 5px;">
                            Automatically detects when kiln sitter has shut off the kiln and ends the firing schedule
                        </p>
                    </div>

                    <div id="kiln-sitter-advanced" style="display: none;">
                        <div class="input-group" style="margin-bottom: 10px;">
                            <label>Detection Threshold (%): <span id="ks-detection-threshold-value">10.0</span></label>
                            <input type="range" id="ks-detection-threshold-slider" min="5" max="50" step="5" value="10" style="width: 100%;">
                            <p style="color: #999; font-size: 0.8em; margin-top: 5px;">
                                Minimum relay output to consider kiln as "trying to heat"
                            </p>
                        </div>
                        <div class="input-group" style="margin-bottom: 10px;">
                            <label>Temp Drop Threshold (¬∞C): <span id="ks-temp-drop-value">5.0</span></label>
                            <input type="range" id="ks-temp-drop-slider" min="1" max="20" step="1" value="5" style="width: 100%;">
                            <p style="color: #999; font-size: 0.8em; margin-top: 5px;">
                                Temperature drop required to detect kiln sitter shutdown
                            </p>
                        </div>
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label>Check Window (cycles): <span id="ks-check-window-value">3</span></label>
                            <input type="range" id="ks-check-window-slider" min="2" max="10" step="1" value="3" style="width: 100%;">
                            <p style="color: #999; font-size: 0.8em; margin-top: 5px;">
                                Number of temperature readings to compare (each ~10 seconds)
                            </p>
                        </div>
                    </div>

                    <button class="btn-primary" onclick="updateKilnSitterSettings()" style="width: 100%;">
                        Apply Kiln Sitter Settings
                    </button>

                    <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 6px; font-size: 0.85em;">
                        <strong>How it works:</strong> When enabled, the system monitors temperature during firing. If temperature drops while the relay is trying to heat, the system detects that the kiln sitter has mechanically shut off the kiln and automatically ends the firing schedule, logging peak temperature and cone data.
                    </div>
                </div>

                <div class="card">
                    <h2>Display Settings</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        Configure dashboard display and graph update frequency
                    </p>

                    <div class="input-group" style="margin-bottom: 15px;">
                        <label>Temperature Unit:</label>
                        <select id="temperature-unit-select" style="width: 100%; margin-top: 8px;">
                            <option value="C">Celsius (¬∞C)</option>
                            <option value="F">Fahrenheit (¬∞F)</option>
                        </select>
                        <p style="color: #999; font-size: 0.8em; margin-top: 5px;">
                            All settings remain stored in Celsius. This only affects display.
                        </p>
                    </div>

                    <div class="input-group" style="margin-bottom: 15px;">
                        <label>Graph Update Frequency (seconds): <span id="graph-update-value">2</span></label>
                        <input type="range" id="graph-update-slider" min="1" max="30" step="1" value="2" style="width: 100%;">
                        <p style="color: #999; font-size: 0.8em; margin-top: 5px;">
                            How often the temperature history graph updates with new data points
                        </p>
                    </div>
                    <button class="btn-primary" onclick="updateDisplaySettings()" style="width: 100%;">
                        Apply Display Settings
                    </button>
                </div>

                <div class="card">
                    <h2>Thermocouple Calibration</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        Calibrate your thermocouple using multiple data points for non-linear correction across temperature ranges
                    </p>

                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 1em; margin-bottom: 10px;">Calibration Points</h3>
                        <div id="calibration-points-container" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                <thead>
                                    <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                        <th style="padding: 8px; text-align: left;">Sensor Reading (¬∞C)</th>
                                        <th style="padding: 8px; text-align: left;">Actual Temp (¬∞C)</th>
                                        <th style="padding: 8px; text-align: left;">Offset (¬∞C)</th>
                                        <th style="padding: 8px; text-align: center; width: 60px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="calibration-points-table">
                                    <tr>
                                        <td colspan="4" style="padding: 20px; text-align: center; color: #999;">
                                            No calibration points added yet
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="font-size: 0.95em; margin-bottom: 10px;">Add Calibration Point</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <label style="display: block; font-size: 0.85em; margin-bottom: 5px; color: #666;">Sensor Reading (¬∞C):</label>
                                    <input type="number" id="new-sensor-temp" step="0.1" placeholder="e.g., 500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.9em;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85em; margin-bottom: 5px; color: #666;">Actual Temperature (¬∞C):</label>
                                    <input type="number" id="new-actual-temp" step="0.1" placeholder="e.g., 510" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.9em;">
                                </div>
                            </div>
                            <button class="btn-primary" onclick="addCalibrationPoint()" style="width: 100%;">
                                Add Point
                            </button>
                        </div>

                        <button class="btn-primary" onclick="saveCalibrationPoints()" style="width: 100%; background: #4caf50;">
                            Save Calibration
                        </button>
                    </div>

                    <div style="padding: 10px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 6px; font-size: 0.85em;">
                        <strong>How it works:</strong> Add calibration points by comparing sensor readings with known accurate temperatures (e.g., from pyrometric cones, reference thermometer, or cone offset calculator). The system will interpolate between points for non-linear correction.
                        <br><br>
                        <a href="https://hotkilns.com/support/cone-offset-calculator" target="_blank" rel="noopener noreferrer" style="color: #2196f3; text-decoration: underline;">Calculate temperature offsets using cone measurements.</a>
                    </div>
                </div>

                <div class="card">
                    <h2>Hardware Settings</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        Hardware configuration (read-only, requires server restart to change)
                    </p>

                    <div class="info-row">
                        <span class="info-label">Relay Pin:</span>
                        <span class="info-value" id="hw-relay-pin">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Thermocouple CS Pin:</span>
                        <span class="info-value" id="hw-tc-cs-pin">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Thermocouple Type:</span>
                        <span class="info-value" id="hw-tc-type">--</span>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.85em;">
                        <strong>Note:</strong> Hardware settings require editing <code>config.json</code> and restarting the server.
                    </div>
                </div>

                <div class="card">
                    <h2>Web Server Settings</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        Web server configuration (read-only, requires server restart to change)
                    </p>

                    <div class="info-row">
                        <span class="info-label">Host:</span>
                        <span class="info-value" id="web-host">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Port:</span>
                        <span class="info-value" id="web-port">--</span>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.85em;">
                        <strong>Note:</strong> Web settings require editing <code>config.json</code> and restarting the server.
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        // Chart setup
        const ctx = document.getElementById('tempChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperature',
                    data: [],
                    borderColor: '#764ba2',
                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    spanGaps: true
                }, {
                    label: 'Setpoint',
                    data: [],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    tension: 0.4,
                    fill: false,
                    spanGaps: true
                }, {
                    label: 'Scheduled',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    borderDash: [10, 5],
                    tension: 0,
                    fill: false,
                    pointRadius: 2,
                    pointBackgroundColor: '#10b981',
                    spanGaps: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Temperature (¬∞C)'
                        },
                        beginAtZero: false
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });

        let currentScheduleName = '';
        let editingSchedule = false;
        let scheduleStartTime = null;
        let scheduleStartTemp = null;
        let loadedScheduleData = null;
        let scheduleMaxTemp = 0;
        let scheduleTotalMinutes = 0;
        let chartTimeInterval = 10;
        let lastGraphUpdate = 0;
        let graphUpdateInterval = 2; // Default 2 seconds
        let temperatureUnit = 'C'; // Current temperature unit (C or F)

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');

            // Activate button
            event.target.classList.add('active');

            // Load data when switching to history tab
            if (tabName === 'history') {
                loadFiringHistory();
            }
        }

        // Temperature conversion functions
        function celsiusToFahrenheit(celsius) {
            if (celsius === null || celsius === undefined) return null;
            return (celsius * 9/5) + 32;
        }

        function fahrenheitToCelsius(fahrenheit) {
            if (fahrenheit === null || fahrenheit === undefined) return null;
            return (fahrenheit - 32) * 5/9;
        }

        function convertTemp(tempC, toUnit) {
            // Convert from Celsius (storage format) to display unit
            if (toUnit === 'F') {
                return celsiusToFahrenheit(tempC);
            }
            return tempC;
        }

        function formatTemp(tempC, unit) {
            // Format temperature for display with proper unit
            if (tempC === null || tempC === undefined || isNaN(tempC)) {
                return '--';
            }
            const converted = convertTemp(tempC, unit);
            return converted.toFixed(1);
        }

        function getTempUnit() {
            return temperatureUnit === 'F' ? '¬∞F' : '¬∞C';
        }

        function getTempLabel() {
            return `Temperature (${getTempUnit()})`;
        }

        // PID slider update handlers
        document.getElementById('kp-slider').addEventListener('input', function(e) {
            document.getElementById('kp-value').textContent = parseFloat(e.target.value).toFixed(1);
        });

        document.getElementById('ki-slider').addEventListener('input', function(e) {
            document.getElementById('ki-value').textContent = parseFloat(e.target.value).toFixed(2);
        });

        document.getElementById('kd-slider').addEventListener('input', function(e) {
            document.getElementById('kd-value').textContent = parseFloat(e.target.value).toFixed(1);
        });

        // PID Advanced slider update handlers
        document.getElementById('pid-sample-time-slider').addEventListener('input', function(e) {
            document.getElementById('pid-sample-time-value').textContent = parseFloat(e.target.value).toFixed(1);
        });

        document.getElementById('output-min-slider').addEventListener('input', function(e) {
            document.getElementById('output-min-value').textContent = e.target.value;
        });

        document.getElementById('output-max-slider').addEventListener('input', function(e) {
            document.getElementById('output-max-value').textContent = e.target.value;
        });

        // Safety settings slider update handlers
        document.getElementById('max-temp-slider').addEventListener('input', function(e) {
            document.getElementById('max-temp-value').textContent = e.target.value;
        });

        document.getElementById('safety-margin-slider').addEventListener('input', function(e) {
            document.getElementById('safety-margin-value').textContent = e.target.value;
        });

        // Control settings slider update handlers
        document.getElementById('relay-cycle-slider').addEventListener('input', function(e) {
            document.getElementById('relay-cycle-value').textContent = parseFloat(e.target.value).toFixed(1);
        });

        document.getElementById('temp-update-slider').addEventListener('input', function(e) {
            document.getElementById('temp-update-value').textContent = parseFloat(e.target.value).toFixed(1);
        });

        // Display settings slider update handlers
        document.getElementById('graph-update-slider').addEventListener('input', function(e) {
            document.getElementById('graph-update-value').textContent = e.target.value;
        });

        async function updatePID() {
            const kp = parseFloat(document.getElementById('kp-slider').value);
            const ki = parseFloat(document.getElementById('ki-slider').value);
            const kd = parseFloat(document.getElementById('kd-slider').value);
            
            try {
                const response = await fetch('/api/pid', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kp, ki, kd })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`PID updated: Kp=${kp.toFixed(1)}, Ki=${ki.toFixed(2)}, Kd=${kd.toFixed(1)}`, 'success');
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to update PID: ' + error.message, 'error');
            }
        }

        async function loadPIDSettings() {
            try {
                const response = await fetch('/api/pid');
                const data = await response.json();
                
                document.getElementById('kp-slider').value = data.kp;
                document.getElementById('ki-slider').value = data.ki;
                document.getElementById('kd-slider').value = data.kd;
                
                document.getElementById('kp-value').textContent = data.kp.toFixed(1);
                document.getElementById('ki-value').textContent = data.ki.toFixed(2);
                document.getElementById('kd-value').textContent = data.kd.toFixed(1);
            } catch (error) {
                console.error('Failed to load PID settings:', error);
            }
        }

        async function autoTunePID() {
            if (!confirm('Auto-tune will heat the kiln to about 100¬∞C and analyze the response. This will take approximately 15-20 minutes. Continue?')) {
                return;
            }

            showAlert('Auto-tune started! Heating kiln and analyzing response. This will take 15-20 minutes. Watch the temperature graph.', 'success');

            try {
                const response = await fetch('/api/autotune', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target_temp: 100, test_duration: 900 })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message + ' Monitor the temperature graph.', 'success');

                    // Poll for completion
                    const checkInterval = setInterval(async () => {
                        try {
                            const statusResponse = await fetch('/api/status');
                            const statusData = await statusResponse.json();

                            if (!statusData.autotune_active) {
                                clearInterval(checkInterval);

                                // Reload PID settings
                                await loadPIDSettings();
                                showAlert('Auto-tune complete! New PID values have been loaded and saved.', 'success');
                            }
                        } catch (error) {
                            console.error('Error checking autotune status:', error);
                        }
                    }, 5000); // Check every 5 seconds

                } else {
                    showAlert('Error: ' + (data.error || 'Failed to start auto-tune'), 'error');
                }
            } catch (error) {
                showAlert('Failed to start auto-tune: ' + error.message, 'error');
            }
        }

        async function updatePIDAdvanced() {
            const sampleTime = parseFloat(document.getElementById('pid-sample-time-slider').value);
            const outputMin = parseFloat(document.getElementById('output-min-slider').value);
            const outputMax = parseFloat(document.getElementById('output-max-slider').value);

            try {
                const response = await fetch('/api/config/pid-advanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sample_time: sampleTime,
                        output_limits: [outputMin, outputMax]
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('PID advanced settings updated successfully', 'success');
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to update PID advanced settings: ' + error.message, 'error');
            }
        }

        async function updateSafetySettings() {
            const maxTemp = parseFloat(document.getElementById('max-temp-slider').value);
            const safetyMargin = parseFloat(document.getElementById('safety-margin-slider').value);

            if (!confirm('Changing safety settings can affect kiln protection. Are you sure?')) {
                return;
            }

            try {
                const response = await fetch('/api/config/safety', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        max_temp: maxTemp,
                        safety_margin: safetyMargin
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Safety settings updated successfully', 'success');
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to update safety settings: ' + error.message, 'error');
            }
        }

        async function updateControlSettings() {
            const relayCycleTime = parseFloat(document.getElementById('relay-cycle-slider').value);
            const tempUpdateInterval = parseFloat(document.getElementById('temp-update-slider').value);

            try {
                const response = await fetch('/api/config/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        relay_cycle_time: relayCycleTime,
                        temp_update_interval: tempUpdateInterval
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Control settings updated successfully', 'success');
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to update control settings: ' + error.message, 'error');
            }
        }

        async function updateDisplaySettings() {
            const graphUpdate = parseFloat(document.getElementById('graph-update-slider').value);
            const tempUnit = document.getElementById('temperature-unit-select').value;

            graphUpdateInterval = graphUpdate;

            // Save temperature unit to backend
            try {
                const response = await fetch('/api/config/display', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        temperature_unit: tempUnit
                    })
                });

                const data = await response.json();

                if (data.success) {
                    temperatureUnit = tempUnit;
                    updateTemperatureDisplays();
                    showAlert(`Display settings updated: ${tempUnit === 'F' ? 'Fahrenheit' : 'Celsius'}, Graph updates every ${graphUpdate} seconds`, 'success');
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to update display settings: ' + error.message, 'error');
            }
        }

        function updateTemperatureDisplays() {
            // Update all temperature unit labels in the UI
            document.querySelectorAll('.temp-unit').forEach(el => {
                el.textContent = getTempUnit();
            });

            // Update chart axis label
            chart.options.scales.y.title.text = getTempLabel();
            chart.update('none');
        }

        // Calibration points management
        let calibrationPoints = [];

        async function loadCalibrationPoints() {
            try {
                const response = await fetch('/api/config/thermocouple-calibration');
                const data = await response.json();

                calibrationPoints = data.calibration_points || [];
                renderCalibrationPointsTable();
            } catch (error) {
                console.error('Failed to load calibration points:', error);
            }
        }

        function renderCalibrationPointsTable() {
            const tbody = document.getElementById('calibration-points-table');

            if (calibrationPoints.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="padding: 20px; text-align: center; color: #999;">
                            No calibration points added yet
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort by sensor temperature
            const sortedPoints = [...calibrationPoints].sort((a, b) => a.sensor_temp - b.sensor_temp);

            tbody.innerHTML = sortedPoints.map((point, index) => {
                const offset = (point.actual_temp - point.sensor_temp).toFixed(1);
                const offsetColor = offset >= 0 ? '#4caf50' : '#f44336';
                return `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px;">${point.sensor_temp.toFixed(1)}</td>
                        <td style="padding: 8px;">${point.actual_temp.toFixed(1)}</td>
                        <td style="padding: 8px; color: ${offsetColor}; font-weight: 500;">
                            ${offset >= 0 ? '+' : ''}${offset}
                        </td>
                        <td style="padding: 8px; text-align: center;">
                            <button onclick="deleteCalibrationPoint(${index})"
                                    style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.85em;"
                                    title="Delete this point">
                                ‚úï
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function addCalibrationPoint() {
            const sensorTemp = parseFloat(document.getElementById('new-sensor-temp').value);
            const actualTemp = parseFloat(document.getElementById('new-actual-temp').value);

            if (isNaN(sensorTemp) || isNaN(actualTemp)) {
                showAlert('Please enter valid numbers for both sensor reading and actual temperature', 'error');
                return;
            }

            // Check if a point with this sensor temp already exists
            const existingIndex = calibrationPoints.findIndex(p => Math.abs(p.sensor_temp - sensorTemp) < 0.1);
            if (existingIndex >= 0) {
                showAlert('A calibration point already exists at this sensor temperature. Delete it first to replace.', 'error');
                return;
            }

            calibrationPoints.push({
                sensor_temp: sensorTemp,
                actual_temp: actualTemp
            });

            renderCalibrationPointsTable();

            // Clear inputs
            document.getElementById('new-sensor-temp').value = '';
            document.getElementById('new-actual-temp').value = '';

            showAlert('Calibration point added. Click "Save Calibration" to apply changes.', 'info');
        }

        function deleteCalibrationPoint(index) {
            const sortedPoints = [...calibrationPoints].sort((a, b) => a.sensor_temp - b.sensor_temp);
            const pointToDelete = sortedPoints[index];

            // Find and remove the point from the original array
            const originalIndex = calibrationPoints.findIndex(
                p => p.sensor_temp === pointToDelete.sensor_temp && p.actual_temp === pointToDelete.actual_temp
            );

            if (originalIndex >= 0) {
                calibrationPoints.splice(originalIndex, 1);
                renderCalibrationPointsTable();
                showAlert('Calibration point removed. Click "Save Calibration" to apply changes.', 'info');
            }
        }

        async function saveCalibrationPoints() {
            try {
                const response = await fetch('/api/config/thermocouple-calibration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        calibration_points: calibrationPoints
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message, 'success');
                    await loadCalibrationPoints(); // Reload to confirm
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to save calibration points: ' + error.message, 'error');
            }
        }

        async function loadDisplaySettings() {
            try {
                const response = await fetch('/api/config/display');
                const displayConfig = await response.json();

                if (displayConfig.temperature_unit) {
                    temperatureUnit = displayConfig.temperature_unit;
                    document.getElementById('temperature-unit-select').value = temperatureUnit;
                    updateTemperatureDisplays();
                }
            } catch (error) {
                console.error('Failed to load display settings:', error);
            }
        }

        async function loadAllSettings() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                // Load PID settings
                if (config.pid) {
                    document.getElementById('kp-slider').value = config.pid.kp;
                    document.getElementById('ki-slider').value = config.pid.ki;
                    document.getElementById('kd-slider').value = config.pid.kd;
                    document.getElementById('kp-value').textContent = config.pid.kp.toFixed(1);
                    document.getElementById('ki-value').textContent = config.pid.ki.toFixed(2);
                    document.getElementById('kd-value').textContent = config.pid.kd.toFixed(1);

                    // PID Advanced
                    document.getElementById('pid-sample-time-slider').value = config.pid.sample_time;
                    document.getElementById('pid-sample-time-value').textContent = config.pid.sample_time.toFixed(1);
                    document.getElementById('output-min-slider').value = config.pid.output_limits[0];
                    document.getElementById('output-min-value').textContent = config.pid.output_limits[0];
                    document.getElementById('output-max-slider').value = config.pid.output_limits[1];
                    document.getElementById('output-max-value').textContent = config.pid.output_limits[1];
                }

                // Load safety settings
                if (config.safety) {
                    document.getElementById('max-temp-slider').value = config.safety.max_temp;
                    document.getElementById('max-temp-value').textContent = config.safety.max_temp;
                    document.getElementById('safety-margin-slider').value = config.safety.safety_margin;
                    document.getElementById('safety-margin-value').textContent = config.safety.safety_margin;
                }

                // Load control settings
                if (config.control) {
                    document.getElementById('relay-cycle-slider').value = config.control.relay_cycle_time;
                    document.getElementById('relay-cycle-value').textContent = config.control.relay_cycle_time.toFixed(1);
                    document.getElementById('temp-update-slider').value = config.control.temp_update_interval;
                    document.getElementById('temp-update-value').textContent = config.control.temp_update_interval.toFixed(1);
                }

                // Load display settings
                if (config.display) {
                    temperatureUnit = config.display.temperature_unit || 'C';
                    document.getElementById('temperature-unit-select').value = temperatureUnit;
                    updateTemperatureDisplays();
                }

                // Load hardware settings (read-only)
                if (config.hardware) {
                    document.getElementById('hw-relay-pin').textContent = config.hardware.relay_pin;
                    document.getElementById('hw-tc-cs-pin').textContent = config.hardware.thermocouple_cs_pin;
                    document.getElementById('hw-tc-type').textContent = config.hardware.thermocouple_type;
                }

                // Load calibration points
                await loadCalibrationPoints();

                // Load web settings (read-only)
                if (config.web) {
                    document.getElementById('web-host').textContent = config.web.host;
                    document.getElementById('web-port').textContent = config.web.port;
                }

            } catch (error) {
                console.error('Failed to load configuration:', error);
            }
        }

        function initializeChartForSchedule(schedule) {
            if (!schedule || schedule.length === 0) return;

            scheduleMaxTemp = Math.max(...schedule.map(s => s.target));
            scheduleTotalMinutes = 0;

            schedule.forEach((segment, index) => {
                const startTemp = index === 0 ? 20 : schedule[index - 1].target;
                const rampTime = Math.abs(segment.target - startTemp) / segment.rate * 60;
                scheduleTotalMinutes += rampTime + segment.hold;
            });

            // Convert max temp to display unit for chart scaling
            const scheduleMaxTempDisplay = convertTemp(scheduleMaxTemp, temperatureUnit);

            const chartMaxTemp = Math.ceil(scheduleMaxTempDisplay * 1.1);
            scheduleTotalMinutes = Math.ceil(scheduleTotalMinutes * 1.1);

            chartTimeInterval = Math.ceil(scheduleTotalMinutes / 25);

            chart.data.labels = [];
            for (let i = 0; i <= scheduleTotalMinutes; i += chartTimeInterval) {
                const hours = Math.floor(i / 60);
                const mins = i % 60;
                chart.data.labels.push(hours > 0 ? `${hours}h ${mins}m` : `${mins}m`);
            }

            chart.data.datasets[0].data = new Array(chart.data.labels.length).fill(null);
            chart.data.datasets[1].data = new Array(chart.data.labels.length).fill(null);

            chart.data.datasets[2].data = [];
            for (let i = 0; i < chart.data.labels.length; i++) {
                const elapsedMinutes = i * chartTimeInterval;
                const scheduledTemp = calculateScheduledTemp(elapsedMinutes, schedule, 20);
                // Convert to display unit for chart
                chart.data.datasets[2].data.push(convertTemp(scheduledTemp, temperatureUnit));
            }

            chart.options.scales.y.min = 0;
            chart.options.scales.y.max = chartMaxTemp;

            chart.update();

            console.log(`Chart initialized: ${scheduleTotalMinutes} minutes, ${chartMaxTemp}${getTempUnit()} max, ${chartTimeInterval}min intervals`);
        }
        
        function calculateScheduledTemp(elapsedMinutes, schedule, startTemp) {
            if (!schedule || schedule.length === 0) return null;

            let currentTime = 0;
            let currentTemp = startTemp;

            for (let i = 0; i < schedule.length; i++) {
                const segment = schedule[i];
                const rate = segment.rate / 60;
                const target = segment.target;
                const hold = segment.hold;

                const tempDiff = target - currentTemp;
                const rampTime = Math.abs(tempDiff) / rate;

                if (elapsedMinutes < currentTime + rampTime) {
                    const segmentElapsed = elapsedMinutes - currentTime;
                    return currentTemp + (rate * segmentElapsed * Math.sign(tempDiff));
                }

                currentTime += rampTime;
                currentTemp = target;

                if (elapsedMinutes < currentTime + hold) {
                    return target;
                }

                currentTime += hold;
            }

            return currentTemp;
        }

        function calculateTotalScheduleDuration(schedule, startTemp) {
            if (!schedule || schedule.length === 0) return 0;

            let totalTime = 0;
            let currentTemp = startTemp;

            for (let i = 0; i < schedule.length; i++) {
                const segment = schedule[i];
                const rate = segment.rate / 60; // Convert to ¬∞C/minute
                const target = segment.target;
                const hold = segment.hold;

                const tempDiff = target - currentTemp;
                const rampTime = Math.abs(tempDiff) / rate;

                totalTime += rampTime + hold;
                currentTemp = target;
            }

            return totalTime; // Returns total duration in minutes
        }

        function formatTimeDisplay(minutes) {
            if (minutes === null || minutes === undefined || minutes < 0) {
                return '--';
            }

            const hours = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);

            if (hours > 0) {
                return `${hours}h ${mins}m`;
            } else {
                return `${mins}m`;
            }
        }
        
        function updateChart(timestamp, temp, setpoint) {
            if (!scheduleStartTime || !loadedScheduleData) {
                return;
            }

            // Check if enough time has elapsed since last graph update
            const now = Date.now();
            if (now - lastGraphUpdate < graphUpdateInterval * 1000) {
                return; // Skip this update
            }
            lastGraphUpdate = now;

            const elapsedMs = new Date(timestamp) - scheduleStartTime;
            const elapsedMinutes = elapsedMs / (1000 * 60);

            const index = Math.round(elapsedMinutes / chartTimeInterval);

            if (index >= chart.data.labels.length) {
                const newMinutes = (index + 1) * chartTimeInterval;
                const hours = Math.floor(newMinutes / 60);
                const mins = newMinutes % 60;
                chart.data.labels.push(hours > 0 ? `${hours}h ${mins}m` : `${mins}m`);
                chart.data.datasets[0].data.push(null);
                chart.data.datasets[1].data.push(null);

                const scheduledTemp = calculateScheduledTemp(newMinutes, loadedScheduleData, scheduleStartTemp);
                chart.data.datasets[2].data.push(convertTemp(scheduledTemp, temperatureUnit));

                scheduleTotalMinutes = newMinutes;
            }

            if (index >= 0 && index < chart.data.labels.length) {
                // Convert temperatures to display unit for chart
                chart.data.datasets[0].data[index] = convertTemp(temp, temperatureUnit);
                chart.data.datasets[1].data[index] = convertTemp(setpoint, temperatureUnit);
            }

            const tempDisplay = convertTemp(temp, temperatureUnit);
            const setpointDisplay = convertTemp(setpoint, temperatureUnit);

            if (tempDisplay > chart.options.scales.y.max) {
                chart.options.scales.y.max = Math.ceil(tempDisplay * 1.1);
            }
            if (setpointDisplay > chart.options.scales.y.max) {
                chart.options.scales.y.max = Math.ceil(setpointDisplay * 1.1);
            }

            chart.update('none');
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        async function loadScheduleList() {
            try {
                const response = await fetch('/api/schedules');
                const schedules = await response.json();
                
                const listEl = document.getElementById('schedule-list');
                const selectEl = document.getElementById('schedule-select');
                
                if (!listEl || !selectEl) {
                    console.error('Could not find schedule-list or schedule-select elements');
                    return;
                }
                
                if (schedules.length === 0) {
                    listEl.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No schedules found. Create one to get started!</p>';
                    selectEl.innerHTML = '<option value="">-- No schedules available --</option>';
                    return;
                }
                
                listEl.innerHTML = '';
                selectEl.innerHTML = '<option value="">-- Select a schedule --</option>';
                
                schedules.forEach(schedule => {
                    const item = document.createElement('div');
                    item.className = 'schedule-item';
                    const maxTempDisplay = formatTemp(schedule.max_temp, temperatureUnit);
                    item.innerHTML = `
                        <div class="schedule-info">
                            <div class="schedule-name">${schedule.name}</div>
                            <div class="schedule-details">${schedule.segments} segments ‚Ä¢ Max: ${maxTempDisplay}${getTempUnit()}</div>
                        </div>
                        <div class="schedule-actions">
                            <button class="btn-primary btn-small" onclick="loadSchedule('${schedule.name}')">Load</button>
                            <button class="btn-primary btn-small" onclick="editSchedule('${schedule.name}')">Edit</button>
                            <button class="btn-danger btn-small" onclick="deleteSchedule('${schedule.name}')">Delete</button>
                        </div>
                    `;
                    listEl.appendChild(item);

                    const option = document.createElement('option');
                    option.value = schedule.name;
                    option.textContent = `${schedule.name} (${schedule.segments} segments, ${maxTempDisplay}${getTempUnit()})`;
                    selectEl.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading schedules:', error);
                showAlert('Failed to load schedules: ' + error.message, 'error');
            }
        }

        async function loadSchedule(name) {
            try {
                const scheduleResponse = await fetch(`/api/schedules/${name}`);
                const schedule = await scheduleResponse.json();
                loadedScheduleData = schedule;
                
                initializeChartForSchedule(schedule);
                
                const response = await fetch(`/api/load-schedule/${name}`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    currentScheduleName = name;
                    document.getElementById('schedule-select').value = name;
                    document.getElementById('start-btn').disabled = false;
                    
                    await displayScheduleSummary(name);
                    
                    showAlert(`Schedule "${name}" loaded successfully`, 'success');
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to load schedule: ' + error.message, 'error');
            }
        }

        async function deleteSchedule(name) {
            if (!confirm(`Are you sure you want to delete the schedule "${name}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/schedules/${name}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Schedule "${name}" deleted`, 'success');
                    loadScheduleList();
                    if (currentScheduleName === name) {
                        currentScheduleName = '';
                        document.getElementById('schedule-select').value = '';
                        document.getElementById('start-btn').disabled = true;
                    }
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to delete schedule: ' + error.message, 'error');
            }
        }

        async function editSchedule(name) {
            try {
                const response = await fetch(`/api/schedules/${name}`);
                const schedule = await response.json();

                document.getElementById('schedule-name').value = name;
                document.getElementById('segment-editor').innerHTML = '';

                schedule.forEach((segment, index) => {
                    // Convert stored Celsius values to display unit
                    const displaySegment = {
                        rate: temperatureUnit === 'F' ? (segment.rate * 9/5) : segment.rate,
                        target: convertTemp(segment.target, temperatureUnit),
                        hold: segment.hold
                    };
                    addSegment(displaySegment);
                });

                editingSchedule = true;
                document.getElementById('schedule-editor').style.display = 'block';
                document.getElementById('schedule-editor').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                showAlert('Failed to load schedule for editing: ' + error.message, 'error');
            }
        }

        function showScheduleEditor() {
            document.getElementById('schedule-name').value = '';
            document.getElementById('segment-editor').innerHTML = '';
            addSegment();
            editingSchedule = false;
            document.getElementById('schedule-editor').style.display = 'block';
            document.getElementById('schedule-editor').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('schedule-editor').style.display = 'none';
        }

        let segmentCounter = 0;

        function addSegment(data = null) {
            const editor = document.getElementById('segment-editor');
            const segmentId = `segment-${segmentCounter++}`;

            // Default values in the current display unit
            const defaultRate = temperatureUnit === 'F' ? 180 : 100;  // 100¬∞C/hr ‚âà 180¬∞F/hr
            const defaultTarget = temperatureUnit === 'F' ? 1112 : 600;  // 600¬∞C ‚âà 1112¬∞F

            const segment = document.createElement('div');
            segment.className = 'segment-item';
            segment.id = segmentId;
            segment.innerHTML = `
                <div class="input-group">
                    <label>Rate (${getTempUnit()}/hr):</label>
                    <input type="number" class="segment-rate" value="${data?.rate || defaultRate}" min="1" max="${temperatureUnit === 'F' ? 900 : 500}" step="${temperatureUnit === 'F' ? '5' : '1'}">
                </div>
                <div class="input-group">
                    <label>Target (${getTempUnit()}):</label>
                    <input type="number" class="segment-target" value="${data?.target || defaultTarget}" min="0" max="${temperatureUnit === 'F' ? 2732 : 1500}" step="${temperatureUnit === 'F' ? '5' : '1'}">
                </div>
                <div class="input-group">
                    <label>Hold (min):</label>
                    <input type="number" class="segment-hold" value="${data?.hold || 0}" min="0" max="999">
                </div>
                <button class="btn-remove" onclick="removeSegment('${segmentId}')">Remove</button>
            `;
            editor.appendChild(segment);
        }

        function removeSegment(segmentId) {
            document.getElementById(segmentId).remove();
        }

        async function saveSchedule() {
            const name = document.getElementById('schedule-name').value.trim();
            if (!name) {
                showAlert('Please enter a schedule name', 'error');
                return;
            }

            const segments = [];
            const segmentItems = document.querySelectorAll('.segment-item');

            if (segmentItems.length === 0) {
                showAlert('Please add at least one segment', 'error');
                return;
            }

            segmentItems.forEach(item => {
                let rate = parseFloat(item.querySelector('.segment-rate').value);
                let target = parseFloat(item.querySelector('.segment-target').value);
                const hold = parseFloat(item.querySelector('.segment-hold').value);

                // Convert from display unit to Celsius for storage
                if (temperatureUnit === 'F') {
                    rate = rate * 5/9;  // Convert ¬∞F/hr to ¬∞C/hr
                    target = fahrenheitToCelsius(target);  // Convert ¬∞F to ¬∞C
                }

                segments.push({
                    rate: Math.round(rate),
                    target: Math.round(target),
                    hold: hold
                });
            });

            try {
                const response = await fetch(`/api/schedules/${name}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(segments)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`Schedule "${name}" saved successfully (stored in Celsius)`, 'success');
                    cancelEdit();
                    loadScheduleList();
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to save schedule: ' + error.message, 'error');
            }
        }

        async function displayScheduleSummary(name) {
            try {
                const response = await fetch(`/api/schedules/${name}`);
                const schedule = await response.json();

                document.getElementById('active-schedule-name').textContent = name;

                let totalTime = 0;
                let summaryHTML = '<div style="margin-top: 10px;">';

                schedule.forEach((segment, index) => {
                    const startTemp = index === 0 ? 20 : schedule[index - 1].target;
                    const rampTime = Math.abs(segment.target - startTemp) / segment.rate * 60;
                    const totalSegmentTime = rampTime + segment.hold;
                    totalTime += totalSegmentTime;

                    // Display temperatures in selected unit
                    const rateDisplay = temperatureUnit === 'F'
                        ? (segment.rate * 9/5).toFixed(0)  // Convert rate to ¬∞F/hr
                        : segment.rate;
                    const targetDisplay = formatTemp(segment.target, temperatureUnit);

                    summaryHTML += `
                        <div class="schedule-segment-item">
                            <div class="segment-title">Segment ${index + 1}</div>
                            <div class="segment-details">
                                Rate: ${rateDisplay}${getTempUnit()}/hr ‚Üí Target: ${targetDisplay}${getTempUnit()}
                                ${segment.hold > 0 ? ` ‚Üí Hold: ${segment.hold} min` : ''}
                            </div>
                            <div class="segment-time">
                                Est. time: ${Math.round(totalSegmentTime)} minutes
                            </div>
                        </div>
                    `;
                });

                summaryHTML += `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #ddd; font-weight: bold; color: #333;">
                        Total estimated time: ${Math.round(totalTime)} minutes (${(totalTime / 60).toFixed(1)} hours)
                    </div>
                `;
                summaryHTML += '</div>';

                document.getElementById('active-schedule-summary').innerHTML = summaryHTML;

            } catch (error) {
                console.error('Failed to load schedule summary:', error);
                document.getElementById('active-schedule-summary').textContent = 'Error loading schedule details';
            }
        }

        document.getElementById('schedule-select').addEventListener('change', function(e) {
            const name = e.target.value;
            if (name) {
                loadSchedule(name);
            } else {
                currentScheduleName = '';
                loadedScheduleData = null;
                scheduleStartTime = null;
                scheduleStartTemp = null;
                scheduleMaxTemp = 0;
                scheduleTotalMinutes = 0;
                
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.data.datasets[1].data = [];
                chart.data.datasets[2].data = [];
                chart.options.scales.y.min = undefined;
                chart.options.scales.y.max = undefined;
                chart.update();
                
                document.getElementById('start-btn').disabled = true;
                document.getElementById('active-schedule-name').textContent = 'No schedule loaded';
                document.getElementById('active-schedule-summary').textContent = 'Select a schedule from the controls section to begin';
            }
        });

        function updateTemperatureUnit(unit) {
            // Update temperature unit display throughout the page
            const unitSymbol = unit === 'F' ? '¬∞F' : '¬∞C';

            // Update main temperature display
            const tempUnitMain = document.getElementById('temp-unit-main');
            if (tempUnitMain) {
                tempUnitMain.textContent = unitSymbol;
            } else {
                console.error('Could not find temp-unit-main element');
            }

            // Update setpoint display
            const tempUnitSetpoint = document.getElementById('temp-unit-setpoint');
            if (tempUnitSetpoint) {
                tempUnitSetpoint.textContent = unitSymbol;
            } else {
                console.error('Could not find temp-unit-setpoint element');
            }

            // Update chart Y-axis label
            if (chart && chart.options && chart.options.scales && chart.options.scales.y) {
                chart.options.scales.y.title.text = `Temperature (${unitSymbol})`;
                chart.update('none'); // Update without animation
            } else {
                console.warn('Chart not available for update');
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // Update temperature unit if provided
                if (data.temperature_unit) {
                    updateTemperatureUnit(data.temperature_unit);
                }

                const statusIndicator = document.getElementById('status-indicator');
                
                const wasFiring = statusIndicator && statusIndicator.classList.contains('active');
                const isFiring = data.firing_active && !data.emergency_stop;
                
                if (isFiring && !wasFiring && loadedScheduleData) {
                    scheduleStartTime = new Date(data.timestamp);
                    scheduleStartTemp = data.temperature;
                    console.log('üî• Firing started!');
                    console.log('   Schedule base temp:', scheduleStartTemp, '¬∞C');
                    console.log('   Schedule base time:', scheduleStartTime);
                    console.log('   Loaded schedule:', loadedScheduleData);

                    for (let i = 0; i < chart.data.labels.length; i++) {
                        const elapsedMinutes = i * chartTimeInterval;
                        const scheduledTemp = calculateScheduledTemp(elapsedMinutes, loadedScheduleData, scheduleStartTemp);
                        // Convert to display unit for chart
                        chart.data.datasets[2].data[i] = convertTemp(scheduledTemp, temperatureUnit);
                    }
                    chart.update();
                }
                
                if (!isFiring && wasFiring) {
                    scheduleStartTime = null;
                    scheduleStartTemp = null;
                    console.log('Firing stopped');
                }
                
                // Convert and display temperatures based on selected unit
                const temp = formatTemp(data.temperature, temperatureUnit);
                const setpoint = formatTemp(data.setpoint, temperatureUnit);
                document.getElementById('current-temp').textContent = temp;
                document.getElementById('setpoint').textContent = setpoint;
                document.getElementById('output').textContent = data.output.toFixed(1);
                document.getElementById('output-bar').style.width = data.output + '%';
                
                const statusText = document.getElementById('firing-status');
                const startBtn = document.getElementById('start-btn');
                const stopBtn = document.getElementById('stop-btn');
                
                if (data.autotune_active) {
                    statusIndicator.className = 'status-indicator active';
                    statusText.textContent = 'Auto-Tuning PID';
                    startBtn.disabled = true;
                    stopBtn.disabled = true;
                } else if (data.emergency_stop) {
                    statusIndicator.className = 'status-indicator emergency';
                    statusText.textContent = 'EMERGENCY STOP';
                    startBtn.disabled = true;
                    stopBtn.disabled = true;
                } else if (data.firing_active) {
                    statusIndicator.className = 'status-indicator active';
                    statusText.textContent = 'Firing Active';
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                } else {
                    statusIndicator.className = 'status-indicator inactive';
                    statusText.textContent = 'Idle';
                    startBtn.disabled = !currentScheduleName;
                    stopBtn.disabled = true;
                }
                
                document.getElementById('current-segment').textContent = data.current_segment + 1;
                document.getElementById('total-segments').textContent = data.total_segments;
                document.getElementById('last-update').textContent = new Date(data.timestamp).toLocaleTimeString();

                // Update elapsed time and time remaining
                const elapsedTimeElement = document.getElementById('elapsed-time');
                const timeRemainingElement = document.getElementById('time-remaining');

                if (data.firing_active && data.start_time && data.schedule && data.schedule.length > 0) {
                    // Calculate elapsed time
                    const startTime = new Date(data.start_time);
                    const currentTime = new Date(data.timestamp);
                    const elapsedMs = currentTime - startTime;
                    const elapsedMinutes = elapsedMs / (1000 * 60);

                    // Calculate total duration and time remaining
                    const startTemp = scheduleStartTemp || data.temperature || 20;
                    const totalDurationMinutes = calculateTotalScheduleDuration(data.schedule, startTemp);
                    const remainingMinutes = totalDurationMinutes - elapsedMinutes;

                    elapsedTimeElement.textContent = formatTimeDisplay(elapsedMinutes);
                    timeRemainingElement.textContent = remainingMinutes > 0 ? formatTimeDisplay(remainingMinutes) : '0m';
                } else {
                    elapsedTimeElement.textContent = '--';
                    timeRemainingElement.textContent = '--';
                }

                if (data.pid_kp !== undefined) {
                    document.getElementById('pid-display').textContent =
                        `Kp:${data.pid_kp.toFixed(1)} Ki:${data.pid_ki.toFixed(2)} Kd:${data.pid_kd.toFixed(1)}`;
                }

                // Update pyrometric cone display
                const coneDisplay = document.getElementById('cone-display');
                const coneValue = document.getElementById('cone-value');
                const coneInfo = document.getElementById('cone-info');

                if (data.firing_active && data.cone) {
                    // Show cone display with current cone value
                    coneDisplay.style.display = 'block';
                    coneValue.textContent = `‚ñ≥${data.cone}`;

                    // Show interpolation info if between cones
                    if (data.cone_lower && data.cone_upper && data.cone_fraction !== undefined) {
                        const percentage = (data.cone_fraction * 100).toFixed(0);
                        coneInfo.textContent = `Between ‚ñ≥${data.cone_lower} and ‚ñ≥${data.cone_upper} (${percentage}%)`;
                    } else {
                        coneInfo.textContent = 'Tracking heat-work';
                    }
                } else if (data.firing_active && !data.cone && data.heat_work !== undefined && data.heat_work > 0) {
                    // Show that heat-work is accumulating but no cone reached yet
                    coneDisplay.style.display = 'block';
                    coneValue.textContent = '< ‚ñ≥022';
                    coneInfo.textContent = 'Accumulating heat-work';
                } else {
                    // Hide cone display when not firing
                    coneDisplay.style.display = 'none';
                }

                if (data.temperature !== null && isFiring) {
                    updateChart(data.timestamp, data.temperature, data.setpoint);
                }

            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        async function startFiring() {
            if (!currentScheduleName) {
                showAlert('Please select a schedule first', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to start firing with schedule "${currentScheduleName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/start', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Firing cycle started successfully', 'success');
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to start firing: ' + error.message, 'error');
            }
        }

        async function stopFiring() {
            if (!confirm('EMERGENCY STOP: Are you sure you want to stop the firing cycle?')) {
                return;
            }

            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    showAlert('Firing stopped', 'success');
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to stop firing: ' + error.message, 'error');
            }
        }

        async function loadFiringData(data) {
            /**
             * Helper function to load firing schedule and data into the UI
             * Used both for auto-loading active firings and manual resume
             */
            if (data.schedule_name && data.schedule) {
                currentScheduleName = data.schedule_name;
                loadedScheduleData = data.schedule;

                // Update UI to show loaded schedule
                document.getElementById('schedule-select').value = data.schedule_name;
                document.getElementById('start-btn').disabled = true; // Already firing

                // Display schedule summary
                await displayScheduleSummary(data.schedule_name);

                // Initialize chart with the schedule
                initializeChartForSchedule(data.schedule);

                // Set the schedule start time from the saved state
                scheduleStartTime = new Date(data.start_time * 1000);

                // Find the initial temperature from data log
                if (data.data_log && data.data_log.length > 0) {
                    scheduleStartTemp = data.data_log[0].temp;
                } else {
                    scheduleStartTemp = 20; // Default fallback
                }

                console.log('üìä Loaded schedule:', data.schedule_name);
                console.log('   Schedule base temp:', scheduleStartTemp, '¬∞C');
                console.log('   Schedule base time:', scheduleStartTime);

                // Repopulate the chart with historical data
                if (data.data_log && data.data_log.length > 0) {
                    console.log('üìà Loading', data.data_log.length, 'historical data points');

                    // Calculate scheduled temperatures for the chart (convert to display unit)
                    for (let i = 0; i < chart.data.labels.length; i++) {
                        const elapsedMinutes = i * chartTimeInterval;
                        const scheduledTemp = calculateScheduledTemp(elapsedMinutes, loadedScheduleData, scheduleStartTemp);
                        chart.data.datasets[2].data[i] = convertTemp(scheduledTemp, temperatureUnit);
                    }

                    // Plot all historical data points (convert to display unit)
                    data.data_log.forEach(entry => {
                        const entryTime = new Date(entry.time);
                        const elapsedMs = entryTime - scheduleStartTime;
                        const elapsedMinutes = elapsedMs / (1000 * 60);
                        const index = Math.round(elapsedMinutes / chartTimeInterval);

                        if (index >= 0) {
                            // Extend chart if needed
                            while (index >= chart.data.labels.length) {
                                const newMinutes = chart.data.labels.length * chartTimeInterval;
                                const hours = Math.floor(newMinutes / 60);
                                const mins = newMinutes % 60;
                                chart.data.labels.push(hours > 0 ? `${hours}h ${mins}m` : `${mins}m`);
                                chart.data.datasets[0].data.push(null);
                                chart.data.datasets[1].data.push(null);

                                const scheduledTemp = calculateScheduledTemp(newMinutes, loadedScheduleData, scheduleStartTemp);
                                chart.data.datasets[2].data.push(convertTemp(scheduledTemp, temperatureUnit));
                            }

                            // Plot the data point (convert to display unit)
                            chart.data.datasets[0].data[index] = convertTemp(entry.temp, temperatureUnit);
                            chart.data.datasets[1].data[index] = convertTemp(entry.setpoint, temperatureUnit);

                            // Update chart scale if needed
                            const tempDisplay = convertTemp(entry.temp, temperatureUnit);
                            const setpointDisplay = convertTemp(entry.setpoint, temperatureUnit);
                            if (tempDisplay > chart.options.scales.y.max) {
                                chart.options.scales.y.max = Math.ceil(tempDisplay * 1.1);
                            }
                            if (setpointDisplay > chart.options.scales.y.max) {
                                chart.options.scales.y.max = Math.ceil(setpointDisplay * 1.1);
                            }
                        }
                    });

                    chart.update();
                    console.log('‚úÖ Historical temperature data restored to chart');
                }
            }
        }

        async function checkResumeState() {
            /**
             * Check if we should auto-load an active firing or show the resume prompt
             * - If firing is active: auto-load the current schedule and data (browser refresh)
             * - If firing is not active but state exists: show resume prompt (server restart)
             */
            try {
                // First, check if a firing is currently active
                const currentResponse = await fetch('/api/current-firing');
                const currentData = await currentResponse.json();

                if (currentData.firing_active) {
                    // Firing is active - auto-load the current firing (browser refresh scenario)
                    console.log('üîÑ Active firing detected - auto-loading current state');
                    await loadFiringData(currentData);
                    // Don't show the resume card
                    document.getElementById('resume-card').style.display = 'none';
                    return;
                }

                // Firing is not active - check if there's a saved state to resume
                const resumeResponse = await fetch('/api/resume-check');
                const resumeData = await resumeResponse.json();

                if (resumeData.can_resume) {
                    // Show the resume prompt (server restart scenario)
                    const resumeCard = document.getElementById('resume-card');
                    resumeCard.style.display = 'block';

                    const state = resumeData.state;
                    document.getElementById('resume-schedule-name').textContent =
                        state.schedule_name || 'Unknown';
                    document.getElementById('resume-segment').textContent =
                        `${state.segment + 1} / ${state.total_segments}`;
                    document.getElementById('resume-timestamp').textContent =
                        new Date(state.timestamp).toLocaleString();
                    document.getElementById('resume-elapsed').textContent =
                        formatElapsedTime(state.elapsed_time);

                    console.log('‚ö†Ô∏è Resume state available:', state);
                } else {
                    document.getElementById('resume-card').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking resume state:', error);
            }
        }

        async function resumeFiring() {
            if (!confirm('Resume the interrupted firing from where it left off?')) {
                return;
            }

            try {
                const response = await fetch('/api/resume', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    // Use the shared helper function to load the firing data
                    await loadFiringData(data);

                    showAlert('Firing resumed successfully with schedule and history restored', 'success');
                    document.getElementById('resume-card').style.display = 'none';
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to resume firing: ' + error.message, 'error');
            }
        }

        async function clearResumeState() {
            if (!confirm('Discard the saved firing state? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/clear-resume', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    showAlert('Resume state cleared', 'success');
                    document.getElementById('resume-card').style.display = 'none';
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to clear resume state: ' + error.message, 'error');
            }
        }

        function formatElapsedTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        // Kiln Sitter Settings Functions
        async function loadKilnSitterSettings() {
            try {
                const response = await fetch('/api/config/kiln-sitter');
                const data = await response.json();

                const kilnSitterMode = document.getElementById('kiln-sitter-mode');
                kilnSitterMode.checked = data.kiln_sitter_mode;

                document.getElementById('ks-detection-threshold-slider').value = data.kiln_sitter_detection_threshold;
                document.getElementById('ks-detection-threshold-value').textContent = data.kiln_sitter_detection_threshold.toFixed(1);

                document.getElementById('ks-temp-drop-slider').value = data.kiln_sitter_temp_drop_threshold;
                document.getElementById('ks-temp-drop-value').textContent = data.kiln_sitter_temp_drop_threshold.toFixed(1);

                document.getElementById('ks-check-window-slider').value = data.kiln_sitter_check_window;
                document.getElementById('ks-check-window-value').textContent = data.kiln_sitter_check_window;

                // Toggle advanced settings visibility
                toggleKilnSitterAdvanced();
            } catch (error) {
                console.error('Failed to load kiln sitter settings:', error);
            }
        }

        function toggleKilnSitterAdvanced() {
            const kilnSitterMode = document.getElementById('kiln-sitter-mode').checked;
            const advancedDiv = document.getElementById('kiln-sitter-advanced');
            advancedDiv.style.display = kilnSitterMode ? 'block' : 'none';
        }

        async function updateKilnSitterSettings() {
            const kilnSitterMode = document.getElementById('kiln-sitter-mode').checked;
            const detectionThreshold = parseFloat(document.getElementById('ks-detection-threshold-slider').value);
            const tempDropThreshold = parseFloat(document.getElementById('ks-temp-drop-slider').value);
            const checkWindow = parseInt(document.getElementById('ks-check-window-slider').value);

            try {
                const response = await fetch('/api/config/kiln-sitter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        kiln_sitter_mode: kilnSitterMode,
                        kiln_sitter_detection_threshold: detectionThreshold,
                        kiln_sitter_temp_drop_threshold: tempDropThreshold,
                        kiln_sitter_check_window: checkWindow
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Kiln sitter settings updated successfully', 'success');
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Failed to update kiln sitter settings: ' + error.message, 'error');
            }
        }

        // Firing History Functions
        let firingHistoryChart = null;

        async function loadFiringHistory() {
            try {
                const response = await fetch('/api/firings');
                const firings = await response.json();

                const firingsListDiv = document.getElementById('firings-list');

                if (firings.length === 0) {
                    firingsListDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            No firing history found. Complete a firing to see it here.
                        </div>
                    `;
                    return;
                }

                let html = '';
                for (const firing of firings) {
                    const startDate = new Date(firing.start_time);
                    const kiln_sitter_badge = firing.kiln_sitter_triggered ?
                        '<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.8em; margin-left: 10px;">Kiln Sitter</span>' : '';

                    html += `
                        <div class="schedule-item" onclick="viewFiringDetail('${firing.filename}')" style="cursor: pointer;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong>${firing.schedule_name}</strong>
                                ${kiln_sitter_badge}
                            </div>
                            <div style="font-size: 0.9em; color: #666; margin-bottom: 8px;">
                                ${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString()}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.85em;">
                                <div>
                                    <span style="color: #999;">Peak:</span>
                                    <strong>${firing.peak_temp.toFixed(1)}¬∞C</strong>
                                </div>
                                <div>
                                    <span style="color: #999;">Cone:</span>
                                    <strong>${firing.peak_cone || 'N/A'}</strong>
                                </div>
                                <div>
                                    <span style="color: #999;">Duration:</span>
                                    <strong>${firing.duration_hours.toFixed(1)}h</strong>
                                </div>
                            </div>
                        </div>
                    `;
                }

                firingsListDiv.innerHTML = html;
            } catch (error) {
                console.error('Failed to load firing history:', error);
                document.getElementById('firings-list').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        Failed to load firing history: ${error.message}
                    </div>
                `;
            }
        }

        async function viewFiringDetail(filename) {
            try {
                const response = await fetch(`/api/firings/${filename}`);
                const firingData = await response.json();

                const summary = firingData.summary;
                const dataLog = firingData.data_log;

                // Hide list, show detail
                document.querySelector('#history-tab .card:first-child').style.display = 'none';
                document.getElementById('firing-detail-card').style.display = 'block';

                // Set detail name
                document.getElementById('firing-detail-name').textContent = summary.schedule_name || 'Unknown';

                // Build summary HTML
                const startDate = new Date(summary.start_time);
                const endDate = new Date(summary.end_time);
                const kiln_sitter_info = summary.kiln_sitter_triggered ?
                    '<div class="info-row"><span class="info-label">Kiln Sitter:</span><span class="info-value" style="color: #ff9800;">Triggered</span></div>' : '';

                const summaryHtml = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="info-row">
                            <span class="info-label">Start Time:</span>
                            <span class="info-value">${startDate.toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">End Time:</span>
                            <span class="info-value">${endDate.toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Duration:</span>
                            <span class="info-value">${summary.duration_hours.toFixed(1)} hours</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Peak Temperature:</span>
                            <span class="info-value">${summary.peak_temp.toFixed(1)}¬∞C</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Peak Cone:</span>
                            <span class="info-value">${summary.peak_cone || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Average Rate:</span>
                            <span class="info-value">${summary.average_rate.toFixed(1)}¬∞C/hr</span>
                        </div>
                        ${kiln_sitter_info}
                        <div class="info-row">
                            <span class="info-label">Data Points:</span>
                            <span class="info-value">${summary.total_data_points}</span>
                        </div>
                    </div>
                `;

                document.getElementById('firing-summary').innerHTML = summaryHtml;

                // Create chart
                const ctx = document.getElementById('firingHistoryChart').getContext('2d');

                // Destroy existing chart if it exists
                if (firingHistoryChart) {
                    firingHistoryChart.destroy();
                }

                const labels = dataLog.map(entry => {
                    const hours = entry.elapsed / 3600;
                    return hours.toFixed(1);
                });

                const temps = dataLog.map(entry => entry.temp);
                const setpoints = dataLog.map(entry => entry.setpoint);

                firingHistoryChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Temperature',
                            data: temps,
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Setpoint',
                            data: setpoints,
                            borderColor: '#667eea',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time (hours)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Temperature (¬∞C)'
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Failed to load firing detail:', error);
                showAlert('Failed to load firing detail: ' + error.message, 'error');
            }
        }

        function closeFiringDetail() {
            document.querySelector('#history-tab .card:first-child').style.display = 'block';
            document.getElementById('firing-detail-card').style.display = 'none';

            // Destroy chart
            if (firingHistoryChart) {
                firingHistoryChart.destroy();
                firingHistoryChart = null;
            }
        }

        // Initialize on page load
        // Load available cone list
        async function loadConeList() {
            try {
                const response = await fetch('/api/cones');
                const cones = await response.json();

                const coneSelect = document.getElementById('cone-select');
                if (!coneSelect) {
                    console.error('Could not find cone-select element');
                    return;
                }

                coneSelect.innerHTML = '<option value="">-- Select Cone --</option>';

                cones.forEach(cone => {
                    const option = document.createElement('option');
                    option.value = cone.name;
                    const tempDisplay = formatTemp(cone.temperature_c, temperatureUnit);
                    option.textContent = `Cone ${cone.name} (${tempDisplay}${getTempUnit()})`;
                    coneSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load cones:', error);
                alert('Failed to load cone list');
            }
        }

        // Generate and load a cone fire schedule
        async function loadConeFireSchedule() {
            const cone = document.getElementById('cone-select').value;
            const speed = document.getElementById('speed-select').value;
            const preheat = parseFloat(document.getElementById('preheat-input').value) || 0;
            const hold = parseInt(document.getElementById('hold-input').value) || 0;

            if (!cone) {
                alert('Please select a cone number');
                return;
            }

            try {
                const response = await fetch('/api/cone-fire', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cone: cone,
                        speed: speed,
                        preheat: preheat,
                        hold: hold
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Store the schedule data
                    const schedule = data.schedule;
                    loadedScheduleData = schedule;
                    currentScheduleName = data.message;

                    // Initialize chart for the schedule
                    initializeChartForSchedule(schedule);

                    // Show success message
                    const infoDiv = document.getElementById('cone-fire-info');

                    // Calculate total firing time
                    let totalTime = 0;
                    schedule.forEach(seg => {
                        const rampTime = Math.abs(seg.target - 20) / (seg.rate / 60); // Rough estimate in minutes
                        totalTime += rampTime + seg.hold;
                    });

                    infoDiv.style.display = 'block';
                    infoDiv.innerHTML = `
                        <strong>‚úì ${data.message}</strong><br>
                        <div style="margin-top: 10px;">
                            <strong>Schedule Details:</strong><br>
                            ‚Ä¢ ${schedule.length} segments<br>
                            ‚Ä¢ Estimated time: ${(totalTime / 60).toFixed(1)} hours<br>
                            ‚Ä¢ Max temp: ${formatTemp(schedule[schedule.length-1].target, temperatureUnit)}${getTempUnit()}<br>
                        </div>
                        <div style="margin-top: 10px;">
                            <strong>Segments:</strong><br>
                            ${schedule.map((seg, i) =>
                                `${i+1}. Ramp at ${formatTemp(seg.rate, temperatureUnit)}${getTempUnit()}/hr to ${formatTemp(seg.target, temperatureUnit)}${getTempUnit()}, hold ${seg.hold} min`
                            ).join('<br>')}
                        </div>
                    `;

                    // Update the active schedule display
                    const scheduleName = `Cone ${cone} (${speed})`;
                    document.getElementById('active-schedule-name').textContent = scheduleName;

                    let totalScheduleTime = 0;
                    let summaryHTML = '<div style="margin-top: 10px;">';

                    schedule.forEach((segment, index) => {
                        const startTemp = index === 0 ? 20 : schedule[index - 1].target;
                        const rampTime = Math.abs(segment.target - startTemp) / segment.rate * 60;
                        const totalSegmentTime = rampTime + segment.hold;
                        totalScheduleTime += totalSegmentTime;

                        const rateDisplay = temperatureUnit === 'F'
                            ? (segment.rate * 9/5).toFixed(0)
                            : segment.rate;
                        const targetDisplay = formatTemp(segment.target, temperatureUnit);

                        summaryHTML += `
                            <div class="schedule-segment-item">
                                <div class="segment-title">Segment ${index + 1}</div>
                                <div class="segment-details">
                                    Rate: ${rateDisplay}${getTempUnit()}/hr ‚Üí Target: ${targetDisplay}${getTempUnit()}
                                    ${segment.hold > 0 ? ` ‚Üí Hold: ${segment.hold} min` : ''}
                                </div>
                                <div class="segment-time">
                                    Est. time: ${Math.round(totalSegmentTime)} minutes
                                </div>
                            </div>
                        `;
                    });

                    summaryHTML += `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #ddd; font-weight: bold; color: #333;">
                            Total estimated time: ${Math.round(totalScheduleTime)} minutes (${(totalScheduleTime / 60).toFixed(1)} hours)
                        </div>
                    `;
                    summaryHTML += '</div>';

                    document.getElementById('active-schedule-summary').innerHTML = summaryHTML;

                    // Enable start button
                    document.getElementById('start-btn').disabled = false;

                    showAlert(`Cone ${cone} schedule loaded successfully`, 'success');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Failed to generate cone fire schedule:', error);
                alert('Failed to generate cone fire schedule');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                loadScheduleList();
                loadConeList(); // Load cone list for cone fire mode
                loadPIDSettings();
                loadAllSettings(); // This loads temperature unit preference from config
                loadKilnSitterSettings();
                checkResumeState();
            }, 100);

            // Add event listeners for kiln sitter settings
            const kilnSitterMode = document.getElementById('kiln-sitter-mode');
            if (kilnSitterMode) {
                kilnSitterMode.addEventListener('change', toggleKilnSitterAdvanced);
            }

            // Add event listeners for sliders
            const sliders = [
                'ks-detection-threshold-slider',
                'ks-temp-drop-slider',
                'ks-check-window-slider'
            ];
            sliders.forEach(sliderId => {
                const slider = document.getElementById(sliderId);
                if (slider) {
                    slider.addEventListener('input', function() {
                        const valueId = sliderId.replace('-slider', '-value');
                        const valueSpan = document.getElementById(valueId);
                        if (valueSpan) {
                            valueSpan.textContent = this.value;
                        }
                    });
                }
            });

            updateStatus();
            setInterval(updateStatus, 2000);
        });
    </script>
</body>
</html>